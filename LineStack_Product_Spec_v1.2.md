
# LineStack  
**Stack dialogue screenshots into a clean vertical story.**

> 冻结版开发规格文档（v1.2）  
> 面向海外市场 · 纯前端本地导出 · 移动端优先

---

## 1. 产品概述

**LineStack** 是一款面向影视爱好者与内容创作者的轻量工具，用于将影视剧对话截图整理、裁切并拼接为适合社交平台传播的纵向长图。

核心能力：
- 区分 **关键帧（Keyframe）** 与 **仅台词（Subtitle-only）**
- 仅保留字幕内容并纵向堆叠
- 一键生成干净、连贯的对话长图
- 全流程 **纯前端、本地处理、不上传图片**

---

## 2. 基本约束（已确认）

- 处理方式：纯前端（浏览器本地）
- 主要使用场景：移动端
- 单次最大图片数量：**30 张（硬限制）**
- 输出宽度：**720 / 1080**
- 默认输出宽度：**720**
- **输出格式：JPG**

---

## 3. 图片类型与核心规则

### 3.1 图片类型

- **Keyframe（关键帧）**
  - 保留整张图片（画面 + 台词）
  - 不参与裁切

- **Subtitle-only（仅台词）**
  - 仅保留裁切后的字幕区域
  - 参与统一宽度缩放与纵向堆叠

---

### 3.2 第一张关键帧规则（锁定）

- 当前排序中的 **第 1 张图片**：
  - 强制为 Keyframe
  - 类型不可关闭 / 不可切换
- 若用户通过拖拽或“置顶”调整顺序：
  - **谁位于第 1 位，谁即成为锁定关键帧**

---

## 4. 排序与置顶

### 4.1 默认排序
- 按上传顺序排列

### 4.2 拖拽排序
- 支持自由拖拽
- 拖拽后即为最终导出顺序

### 4.3 置顶（一次性操作）
- 每张图片支持“Move to Top”
- 行为：
  - 将图片移动到列表第 1 位
  - 不存在置顶状态或置顶区

---

## 5. Subtitle-only 裁切规则

### 5.1 裁切方式

#### A. 拖拽裁剪框（主要方式）
- 仅对 Subtitle-only 生效
- 裁剪框规则：
  - 横向固定 100% 宽度
  - 纵向可移动、可调高度
- 裁切参数保存为相对比例：
  - `top_ratio`
  - `height_ratio`

#### B. 快捷裁切（输入 x%）
- 用户输入 `x`（0–100）
- 含义：**只保留底部 x% 高度**
- 自动切换裁切模式为 `bottom_ratio`

---

### 5.2 全局裁切（Apply to all）

- 裁切编辑器默认勾选「Apply to all subtitle-only images」
- 行为：
  - 当前裁切参数保存为 Global Crop
  - 所有 Subtitle-only 默认使用该裁切
- 单张图片可选择关闭全局裁切，使用独立裁切

---

## 6. 输出与拼接规则

### 6.1 宽度统一
- 每个片段处理流程：
  1. 原图 / 裁切后图
  2. 等比缩放至目标宽度（720 / 1080）
  3. 纵向拼接

---

### 6.2 Keyframe 间距（8px）
- 可选开关：Enable keyframe gap
- 生效条件：
  1. Keyframe 数量 ≥ 2
  2. 当前边界为 `Subtitle-only → Keyframe`
- 仅在上述边界插入 8px 间距

---

### 6.3 背景颜色（仅在开启间距时可见）【已确认】

- 该设置仅在 **Enable keyframe gap = ON** 时展示（因为无间距时背景不可见）
- 选项（单选）：
  - 默认：**White `#FFFFFF`**
  - 可选：Black `#000000`
  - 可选：Dark Gray `#333333`
- 作用范围：
  - 仅用于“间距区域”的底色（gap 填充色）
  - 不改变各图片片段本身内容

> 说明：即使最终输出为 JPG（无透明通道），背景色仍用于填充间距区域与画布底色的一致性。

---

## 7. Watermark（署名）

- 用户输入文本
- 固定位置：右下角
- 最大长度：20 字符
- 添加于最终长图底部区域
- 建议样式：
  - 距右 16px，距底 16px
  - 半透明

---

## 8. 导出流程（一次性）

1. 校验图片数量 ≤ 30
2. 读取最终排序结果
3. 校验第 1 张为 Keyframe
4. 逐张处理图片（裁切 → 缩放）
5. 计算总高度（含间距）
6. 创建画布并拼接（gap 区域使用背景色填充）
7. 添加 Watermark（如开启）
8. **导出 JPG 并下载**

---

## 9. 导出风险评估（移动端）

### 9.1 风险阈值

#### Width = 720
- Low: ≤ 20,000 px
- Medium: 20,000–35,000 px
- High: > 35,000 px

#### Width = 1080
- Low: ≤ 14,000 px
- Medium: 14,000–25,000 px
- High: > 25,000 px

---

## 10. 自动分段导出（已确认）

- 当风险为 High 时 **自动启用**
- 单段最大高度：
  - 720：18,000 px
  - 1080：12,000 px
- 分段规则：
  - 仅在图片边界处分段
  - 文件名自动编号：`linestack_01.jpg`, `linestack_02.jpg`

---

## 11. 前端实现注意事项

- 不做拼接实时预览
- 裁切阶段仅处理参数
- 导出时逐张处理，避免同时解码全部图片
- Watermark 最后绘制
- JPG 编码质量参数（quality）⚠️ 需要技术/产品补充默认值（建议默认 0.9 或质量 90）

---

> Product Name: **LineStack**  
> Slogan: *Stack dialogue screenshots into a clean vertical story.*  
> Spec Version: **v1.2 (Frozen)**

